# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

Black Don OS is a user-friendly NixOS configuration based on ZaneyOS, designed for newcomers and experienced users. It features a simplified installation process with sensible defaults and easy customization.

## Common Development Commands

### Building and Deployment
```bash
# Build and switch configuration
sudo nixos-rebuild switch --flake .#HOSTNAME

# Build without switching (test)
sudo nixos-rebuild build --flake .#HOSTNAME

# Show detailed error trace
sudo nixos-rebuild build --flake .#HOSTNAME --show-trace
```

### Git Workflow
```bash
# Check current branch
git branch

# Commit changes
git add .
git commit -m "description"

# Push to repository
git push origin BRANCH-NAME
```

## Do's and Don'ts
- Don't add unnecessary dependencies
- Don't modify core system files without understanding their purpose
- Don't add code that doesn't serve a purpose for the current task
- Don't add anything extra without asking first
- Do test changes before committing
- Do keep the configuration user-friendly for newcomers

## Repository Information

**GitLab Repository**: https://gitlab.com/theblackdon/black-don-os

### Branch Strategy
- **main**: Public-facing simplified configuration for distribution
- **bdos-beta-0.4**: Development branch for new features
- **dons-personal**: Don's personal hosts and settings (not public-facing)

## Architecture Overview

### Key Design Principles
1. **Flexible Desktop Environment**: Choose between tiling WMs (Hyprland/Niri) or traditional DE (GNOME)
2. **Simple Installation**: Minimal questions, sensible defaults
3. **Easy Customization**: All settings in `hosts/HOSTNAME/variables.nix`
4. **Modular Features**: Enable only what you need
5. **Newcomer Friendly**: Great defaults that work out of the box
6. **Optimized Builds**: Only build what you use - disable unused WMs/DEs per host

### Multi-Host Configuration System
- **Flake-based**: Uses Nix flakes for reproducible builds
- **Host-specific configs**: Each computer has its own directory under `hosts/`
- **Hardware profiles**: GPU-specific configurations in `profiles/`
- **Modular design**: Core system, drivers, and home-manager configs separated

### Key Directories
- `hosts/`: Host-specific configurations (hardware.nix, variables.nix, host-packages.nix)
- `modules/core/`: Core system configuration modules
- `modules/drivers/`: Hardware driver configurations (NVIDIA, AMD, Intel)
- `modules/home/`: Home-manager user environment configs
- `modules/home/hyprland/`: Hyprland window manager configuration
- `modules/home/niri/`: Niri window manager configuration
- `modules/home/gnome/`: GNOME desktop environment configuration
- `modules/core/gnome.nix`: GNOME system-level configuration
- `profiles/`: Hardware-specific profiles that import appropriate modules
- `wallpapers/`: System wallpapers for theming

### Configuration Flow
1. `flake.nix` defines hosts and their profiles
2. Profiles import appropriate driver and core modules
3. Host directories contain hardware-specific settings
4. `variables.nix` in each host defines customization options
5. Both Hyprland and Niri are always imported (user selects at login)

### Host Configuration Structure
Each host under `hosts/` contains:
- `default.nix`: Imports hardware.nix and host-packages.nix
- `hardware.nix`: Generated by nixos-generate-config, hardware-specific settings
- `variables.nix`: Host-specific variables (monitors, GPU IDs, preferences, feature toggles)
- `host-packages.nix`: Host-specific package installations

## Key Configuration Files

### Host Variables (`hosts/*/variables.nix`)
Important settings to understand when working with host configurations:

#### Window Manager / Desktop Environment Settings
**New Conditional System** (replaces old "always both" approach):
- `enableHyprland`: Enable Hyprland tiling compositor (default: `true`)
- `enableNiri`: Enable Niri scrollable tiling compositor (default: `true`)
- `enableGnome`: Enable GNOME desktop environment (default: `false`)

**Benefits:**
- Faster builds - only compile what you use
- Perfect for specialized systems (homelab with GNOME, workstations with tiling WMs)
- User selects active WM/DE at login screen (SDDM for tiling WMs, GDM for GNOME)
- Mix and match as needed per host

#### Lock Screen Settings
- `enableHyprlock`: Controls whether hyprlock and hypridle are enabled
- Set to `false` if using DMS or Noctalia lock screens
- Defaults to `true` for backwards compatibility

#### Display Settings
- `extraMonitorSettings`: Monitor configuration for Hyprland
- `intelID`/`nvidiaID`: PCI IDs for NVIDIA Prime support on hybrid laptops
- `clock24h`: 24-hour or 12-hour clock format

#### Application Defaults
- `browser`: Default browser (zen, firefox, vivaldi, brave, chromium)
- `terminal`: Default terminal (kitty, alacritty, ghostty)
- `defaultShell`: Default shell (zsh, fish)
- `keyboardLayout`: Keyboard layout (us, uk, de, fr, etc.)

#### Desktop Environment
- `barChoice`: Status bar choice (waybar, dms, noctalia)
- `waybarChoice`: Waybar theme file path
- `animChoice`: Hyprland animation style
- `stylixImage`: Wallpaper for system theming
- `stylixEnable`: Enable/disable Stylix theming

#### Feature Toggles
All optional features default to `false` for faster installation:
- `enableNFS`: NFS file sharing
- `printEnable`: Printing support
- `thunarEnable`: Thunar file manager
- `controllerSupportEnable`: Gaming controller support
- `flutterdevEnable`: Flutter development environment
- `syncthingEnable`: Syncthing file synchronization
- `enableCommunicationApps`: Discord, Teams, Zoom, Telegram
- `enableExtraBrowsers`: Chromium, Google Chrome, Firefox
- `enableProductivityApps`: Obsidian, GNOME Boxes, QuickEmu

### Flake Configuration (`flake.nix`)
- Defines input sources (nixpkgs, home-manager, stylix, hyprland, niri, etc.)
- Creates host configurations using `mkHost` helper function
- Maps hostnames to hardware profiles
- Includes Flutter development shell for mobile development

### Window Manager Implementation

#### Both Always Available
`modules/home/default.nix` always imports both:
```nix
++ [
  ./niri
  ./hyprland
]
```

Previously this was conditional based on `windowManager` variable, but now both are always loaded.

#### Hyprlock Optional
`modules/home/hyprland/default.nix` conditionally imports hyprlock:
```nix
++ lib.optionals enableHyprlock [
  ./hypridle.nix
  ./hyprlock.nix
];
```

This allows users to disable hyprlock if using alternative lock screens (DMS, Noctalia).

## Installation Script

### Simple Installer (`install.sh`)
The simplified installer asks only essential questions:
1. **Hostname** (with warning about not using "default")
2. **Username** (defaults to current user)
3. **GPU Profile** (auto-detected, confirms with user)

Everything else uses sensible defaults:
- Git config: username@hostname
- Timezone: America/New_York
- Keyboard: us
- Browser: zen
- Terminal: kitty
- Shell: zsh
- Bar: waybar
- All optional features: false (faster install)

Users can customize everything later via `variables.nix`.

## Hardware Support

### GPU Profiles
- **nvidia**: Desktop NVIDIA (dedicated GPU)
- **nvidia-laptop**: Laptop NVIDIA + Intel hybrid (Prime support)
- **amd**: AMD Radeon graphics
- **intel**: Intel integrated graphics
- **vm**: Virtual machine optimized

### Adding New Hosts
New hosts can be added by:
1. Running `./install.sh` on target hardware
2. Script auto-generates hardware config
3. Script creates host directory and variables.nix
4. Script adds host to flake.nix
5. Script builds and switches to new configuration

Manual process:
1. `mkdir -p hosts/NEW-HOST`
2. `nixos-generate-config --show-hardware-config > hosts/NEW-HOST/hardware.nix`
3. Create `hosts/NEW-HOST/variables.nix` based on template
4. Update `flake.nix` to include new host
5. Build: `sudo nixos-rebuild switch --flake .#NEW-HOST`

## Common Development Tasks

### Modifying System Packages
- System-wide: Edit `modules/core/packages.nix`
- Host-specific: Edit `hosts/HOST/host-packages.nix`

### Desktop Customization
- Wallpapers: Add to `wallpapers/` and reference in `variables.nix`
- Waybar themes: Located in `modules/home/waybar/`, select in `variables.nix`
- Hyprland configs: Located in `modules/home/hyprland/`
- Niri configs: Located in `modules/home/niri/`
- GNOME configs: Located in `modules/home/gnome/`

### Window Manager / Desktop Environment Changes
**New Conditional System:**
- WMs/DEs are conditionally imported based on `enableHyprland`, `enableNiri`, and `enableGnome` variables
- Set these in each host's `variables.nix` to control which are built
- SDDM used for Hyprland/Niri (disabled when GNOME enabled)
- GDM used for GNOME (enabled automatically when `enableGnome = true`)
- Default: Hyprland and Niri enabled, GNOME disabled
- Homelab/server use case: Enable GNOME only, disable tiling WMs for faster builds

### Hardware Configuration Updates
- Monitor setup: Update `extraMonitorSettings` in `variables.nix`
- GPU IDs: Use `lspci | grep VGA` to find correct PCI IDs for NVIDIA Prime

## Troubleshooting

### Build Failures
1. Check syntax: `nix flake check`
2. Show metadata: `nix flake metadata`
3. Build with trace: `nixos-rebuild build --flake .#HOST --show-trace`
4. Verify host exists in flake.nix

### Hardware Detection
- Find GPU IDs: `lspci | grep VGA`
- Monitor detection: `hyprctl monitors` (in Hyprland)
- Generate new hardware config if needed

### Common Issues
- **Host not found**: Check hostname matches directory in `hosts/`
- **Monitor issues**: Update `extraMonitorSettings` in `variables.nix`
- **Hyprlock conflicts**: Set `enableHyprlock = false` if using DMS/Noctalia
- **WM/DE not showing at login**: Check enable variables in `variables.nix`
- **GDM and SDDM conflict**: SDDM auto-disables when `enableGnome = true`
- **Long build times**: Disable unused WMs/DEs in `variables.nix` to speed up builds

## Development Workflow

1. Make configuration changes on appropriate branch
2. Test build: `sudo nixos-rebuild build --flake .#HOST`
3. If successful, switch: `sudo nixos-rebuild switch --flake .#HOST`
4. Commit changes: `git add . && git commit -m "description"`
5. Push to repository: `git push origin BRANCH`

## Repository Structure Notes

- Based on ZaneyOS but heavily simplified for newcomers
- Uses NixOS unstable for latest features
- Integrates Stylix for system theming
- Home-manager for user environment management
- Conditional WM/DE loading for optimized builds
- GNOME support for homelab/simple desktop use cases
- Flake-utils for development environments (Flutter)

## Important Reminders for Claude

1. **Use conditional WM/DE system** - respect `enableHyprland`, `enableNiri`, `enableGnome` variables
2. **Never add `windowManager` variable** - it's been removed in favor of enable flags
3. **Keep it simple** - this is for NixOS newcomers
4. **Test changes** - build before committing
5. **Document everything** - users need to understand changes
6. **Respect the architecture** - flexible WM/DE choice is a key feature
7. **Backwards compatibility** - use `or` defaults for new variables (defaults: Hyprland=true, Niri=true, GNOME=false)
8. **Display managers** - SDDM for tiling WMs, GDM for GNOME (auto-managed)

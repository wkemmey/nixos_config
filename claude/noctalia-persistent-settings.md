# Fixing Noctalia Bar Settings Persistence

## Problem
Changes made to Noctalia bar through the GUI settings were not persisting after reboot or logout.

## Root Cause
NixOS uses declarative configuration management. By default, home-manager creates **symlinks** to the Nix store for config files, making them read-only. Any manual changes through the GUI cannot be saved because the files point to immutable store paths.

## Solution (Updated October 26, 2025)

### New Approach: User-Writable Config Files
Instead of managing settings through Nix, we now create a regular writable file that Noctalia can modify directly. This allows GUI changes to persist while maintaining some Nix management for initial setup.

### How It Works Now
1. The Nix config creates a **template** file (`.json.template`)
2. On system activation, the template is copied to `settings.json` **only if it doesn't exist**
3. The `settings.json` file is a regular file (not a symlink), so it's writable
4. GUI changes modify the writable file and persist across reboots
5. The Nix config won't overwrite your changes unless you delete the file

### Workflow for Making Changes
**Option 1: Use the GUI (Recommended)**
1. Open Noctalia settings GUI
2. Make your changes (widgets, colors, layouts, etc.)
3. Changes save automatically to `~/.config/noctalia/settings.json`
4. Changes persist across reboots/logout

**Option 2: Manual Nix Config Updates**
If you want to update the default template in Nix:
1. Make changes in GUI
2. Copy your settings: `cat ~/.config/noctalia/settings.json`
3. Update the template in: `modules/home/noctalia-shell/default.nix`
4. Delete the settings file: `rm ~/.config/noctalia/settings.json`
5. Rebuild: `dcli rebuild`
6. The new template will be copied as your settings file

## Changes Made

### 1. Updated Noctalia Bar Configuration
**File**: `/home/don/black-don-os/modules/home/noctalia-shell/default.nix`

Added complete bar configuration from GUI settings:

```nix
bar = {
  position = "top";
  density = "compact";
  backgroundOpacity = 1;
  floating = false;
  marginHorizontal = 0.25;
  marginVertical = 0.25;
  showCapsule = true;
  widgets = {
    left = [
      { id = "SystemMonitor"; }
      { id = "ActiveWindow"; }
      { id = "MediaMini"; }
    ];
    center = [
      { id = "Workspace"; }
    ];
    right = [
      { id = "ScreenRecorder"; }
      { id = "Tray"; }
      { id = "NotificationHistory"; }
      { id = "Battery"; }
      { id = "Volume"; }
      { id = "Brightness"; }
      { id = "Clock"; }
      { id = "ControlCenter"; }
    ];
  };
};
```

### 2. Fixed Notification System Conflict
**File**: `/home/don/black-don-os/modules/home/default.nix`

**Problem**: swaync (SwayNotificationCenter) was always enabled, conflicting with Noctalia's built-in notification system.

**Solution**: Made swaync conditional - only loads when using Waybar:

```nix
# Before: swaync was always imported
./swaync.nix

# After: swaync only imported when using waybar
++ lib.optionals (actualBarChoice == "waybar") [
  waybarChoice
  ./swaync.nix  # Only use swaync with waybar
]
```

Now:
- `barChoice = "noctalia"` → Uses Noctalia's notification system
- `barChoice = "waybar"` → Uses swaync
- `barChoice = "dms"` → Uses DMS's notification system

## Config File Locations

### Noctalia Runtime Config (Generated by Nix)
- `~/.config/noctalia/settings.json` - Symlink to Nix store (read-only)
- `~/.config/noctalia/colors.json` - User editable (but will be regenerated)

### Noctalia Nix Config (Source of Truth)
- `/home/don/black-don-os/modules/home/noctalia-shell/default.nix`

### Host-Specific Settings
- `/home/don/black-don-os/hosts/leno-desktop/variables.nix`
  - `barChoice = "noctalia"` - Enables Noctalia
  - `windowManager = "niri"` - Window manager choice

## Testing
After making changes:
```bash
dcli rebuild
```

Then logout and login to verify settings persist.

## Key Takeaway
In NixOS, **all persistent configuration changes must be made in `.nix` files**, not in runtime config files. The declarative model ensures reproducibility but requires a different workflow than traditional Linux distributions.

## Date
October 26, 2025
